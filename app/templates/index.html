<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TrueFan Monitor</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <main class="wrap">
    <header class="card header">
      <h1>TRUEFAN MONITOR</h1>
      <span id="updated-at" class="muted">Loading...</span>
    </header>

    <section id="smart-warning" class="warn hidden">
      [ WARN ] SMART access unavailable - reduced monitoring mode
    </section>

    <section class="grid">
      <article class="card">
        <h2>System</h2>
        <div class="row"><span>Mode</span><span id="mode">unknown</span></div>
        <div class="row"><span>Agent</span><span id="agent">unknown</span></div>
        <div class="row"><span>SMART</span><span id="smart">unknown</span></div>
      </article>

      <article class="card">
        <h2>Temperatures</h2>
        <div class="row"><span>CPU</span><span id="temp-cpu">--</span></div>
        <div class="row"><span>NVMe</span><span id="temp-nvme">--</span></div>
        <div class="row"><span>HDD</span><span id="temp-hdd">--</span></div>
      </article>

      <article class="card">
        <h2>Fan Speeds</h2>
        <div id="fan-speeds"></div>
      </article>
    </section>
  </main>

  <script>
    const els = {
      mode: document.getElementById("mode"),
      agent: document.getElementById("agent"),
      smart: document.getElementById("smart"),
      cpu: document.getElementById("temp-cpu"),
      nvme: document.getElementById("temp-nvme"),
      hdd: document.getElementById("temp-hdd"),
      fanSpeeds: document.getElementById("fan-speeds"),
      warning: document.getElementById("smart-warning"),
      updated: document.getElementById("updated-at"),
    };

    function setText(el, value) {
      if (el) {
        el.textContent = String(value);
      }
    }

    function findTemp(sensors, name) {
      if (!Array.isArray(sensors)) {
        return "--";
      }
      const match = sensors.find((item) => item && item.name === name);
      if (!match || match.value === undefined || match.value === null) {
        return "--";
      }
      return `${match.value} C`;
    }

    function render(status) {
      const safe = status && typeof status === "object" ? status : {};
      const capabilities = safe.capabilities && typeof safe.capabilities === "object" ? safe.capabilities : {};
      const sensors = Array.isArray(safe.sensors) ? safe.sensors : [];
      const fan = safe.fan && typeof safe.fan === "object" ? safe.fan : {};
      const smartAvailable = capabilities.smart_available !== false;

      setText(els.mode, safe.mode || "monitoring-only");
      setText(els.agent, safe.agent_available ? "online" : "offline");
      setText(els.smart, smartAvailable ? "available" : "unavailable");
      setText(els.cpu, findTemp(sensors, "cpu"));
      setText(els.nvme, findTemp(sensors, "nvme"));
      setText(els.hdd, findTemp(sensors, "hdd"));
      setText(els.updated, new Date().toLocaleTimeString());

      if (els.warning) {
        els.warning.classList.toggle("hidden", smartAvailable);
      }

      if (els.fanSpeeds) {
        els.fanSpeeds.innerHTML = "";
        for (const [name, value] of Object.entries(fan)) {
          const row = document.createElement("div");
          row.className = "row";
          if (Number(value) === 0) {
            row.classList.add("muted");
          }

          const left = document.createElement("span");
          left.textContent = `${name}:`;
          const right = document.createElement("span");
          right.textContent = `${value} RPM`;
          row.appendChild(left);
          row.appendChild(right);
          els.fanSpeeds.appendChild(row);
        }
      }
    }

    async function pollStatus() {
      try {
        const res = await fetch("/status", { cache: "no-store" });
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        const payload = await res.json();
        render(payload);
      } catch (_error) {
        render({
          mode: "monitoring-only",
          agent_available: false,
          capabilities: { smart_available: false },
          sensors: [],
          fan: {},
        });
      }
    }

    pollStatus();
    window.setInterval(pollStatus, 5000);
  </script>
</body>
</html>
